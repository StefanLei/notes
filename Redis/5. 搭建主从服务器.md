#### Redis 搭建主从复用-读写分离

Redis 支持主从复用。数据可以从主服务器向任意数量的 从服务器上同步，同步使用的是发布/订阅机制。Mater Slave 的模式，Slave 向 Master 发起 SYNC 命令。 可以是 1 Master 多 Slave，可以分层，Slave 下可以再接 Slave，可扩展成树状结构.

###### 修改主服务器的配置

```
# 设置从服务器只读模式
slave-read-only yes

# 设置密码  也可以不设置
requirepass 123456

# 设置主服务器的密码，这里是为了使用哨兵模式后，这个变成slave服务器。所以也指定密码
masterauth 123456
```

###### 修改从服务器的配置

```
# 修改监听的端口，防止冲突
port 6381 

# 指定主服务器的密码
masterauth 123456

# 设置密码  也可以不设置
requirepass 123456

# 设置同步的主服务器地址
slaveof 127.0.0.1 6379
```

先启动主服务器，再启动从服务器

使用 `info replication` 命令查询信息

---

### 全量同步	

[参考链接](https://www.cnblogs.com/hepingqingfeng/p/7263782.html)

redis 全量复制，一般发生在 `slave` 初始化阶段，这时 `salve` 需要将 `master` 上的所有数据都复制一份。具体步骤如下

- `slave`连接`master`，发送 SYNC 命令给`master`
- `master`接受到 SYNC 命令后，开始执行 BGSAVE 命令生成 RDB 文件，并使用缓存区记录这个过程的期间执行的所有的命令。
- `master` BGSAVE 命令执行完成后，向所有的`slave`发送快照文件，并在发送期间继续记录执行的命令。
- `slave`收到快照文件后，就丢弃所有的旧数据，载入收到的快照。
- `master`服务器快照发送完毕后，就开始向`slave`服务器发送缓冲区中的命令
- `slave`服务器完成对快照的载入，开始接受命令请求，并执行来自`master`服务器缓冲区的写命令。



### 增量同步

redis 增量复制，是指`slave`初始化开始正常工作时，`master`服务器发送的写操作同步到`slave`服务器的过程。

主要过程就是，`master`服务器每执行一个写命令，就会向`slave`服务器发送相同写命令。`slave`服务器接受并执行收到的写命令。



### Redis 主从同步策略

主从刚刚连接的时候，进行全量同步；全量同步结束后，进行增量同步。当然，如果需要，slave 在任何时候都可以发起全量同步 。redis 的策略是，先进行增量同步，如果不成功，则要求`slavw`进行全量同步。



### 注意点

如果多个Slave断线了，需要重启的时候，因为只要Slave启动，就会发送sync请求和主机全量同步，当多个同时出现的时候，可能会导致Master IO剧增宕机。 